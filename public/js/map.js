"use strict";function initMap(){map=new google.maps.Map(document.getElementById("map"),{center:{lat:defaultLat,lng:defaultLng},zoom:5})}function showMessageOnMap(e,r){r||(r=map.getCenter());var a=new google.maps.InfoWindow({map:map});a.setPosition(r),a.setContent(e)}function handleLocationError(e,r){var a="Error: The Geolocation service failed.",n="Error: Your browser doesn't support geolocation.";"Ita"===localLanguage&&(a="Errore: Il servizio di geolocazione non ha funzionato.",n="Errore: Il tuo browser non supporta la geolocazione."),showMessageOnMap(e?a:n,r)}function emitUpdateCoords(e,r){var a=io();if(sessionID)a.emit("updateOnlineContactCoords",{uniqueID:user._id,lat:e,lng:r});else{var n="Error: Could not retrive ID from server. Try refreshing the page.";"Ita"===localLanguage&&(n="Errore: Impossibile ricevere ID dal server. Provare a ricaricare la pagina."),showMessageOnMap(n)}}function eraseLocation(){$.ajax({type:"PUT",url:"/updateUserCoordinates",data:{userID:user._id,lat:0,lng:0},success:function(){emitUpdateCoords(0,0),user.lat=0,user.lng=0,removeLocalUserMarker()},error:function(e){console.log("Error: ",e)},complete:function(){}})}function broadcastLocation(){localUserOnMap&&eraseLocation(),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){var r={lat:e.coords.latitude,lng:e.coords.longitude};map.setCenter(r),$.ajax({type:"PUT",url:"/updateUserCoordinates",data:{userID:user._id,lat:r.lat,lng:r.lng},success:function(){emitUpdateCoords(r.lat,r.lng),user.lat=r.lat,user.lng=r.lng,setTimerToXSecondsAfterDelay(2e3,0),setTimerToXSecondsAfterDelay(tenSeconds,tenSeconds)},error:function(e){console.log("Error: ",e)},complete:function(){updateMarkersOnMap()}})},function(){handleLocationError(!0,map.getCenter())}):handleLocationError(!1,map.getCenter())}function styleMarker(e){var r=e,a=document.createElement("style");a.type="text/css",a.innerHTML="* [src='"+r+"'] {border-radius:30px; border:1px solid #000 !important; }",document.getElementsByTagName("head")[0].appendChild(a)}function removeMarker(e){e.setMap(null),e=null}function addMarker(e){var r=e.picture,a=e.name,n=e.id,o=e.uniqueID,t=e.latLng,s=t.lat(),i=t.lng();styleMarker(r);var l=new google.maps.Marker({position:t,map:map,title:a,icon:r,optimized:!1});o!=user._id?l.addListener("click",function(){openChatWindow(a,r,n,o,s,i,!1,!0)}):(l.id="localUserMarker",localUserOnMap=!0),l.uniqueID=o,markersOnMap.push(l)}function isUniqueIDInArray(e,r){for(var a=e.length-1;a>=0;a--)if(e[a].uniqueID===r)return!0;return!1}function updateMarkersOnMap(){for(var e=usersOnline.length-1;e>=0;e--){var r=usersOnline[e];(r.lat||r.lng)&&(isUniqueIDInArray(markersOnMap,r.uniqueID)||localUserOnMap&&r.id===sessionID||(r.latLng=new google.maps.LatLng({lat:r.lat,lng:r.lng}),addMarker(r)))}for(var a=markersOnMap.length-1;a>=0;a--){var n=markersOnMap[a];isUniqueIDInArray(usersOnline,n.uniqueID)||(removeMarker(n),markersOnMap.splice(a,1))}}function removeLocalUserMarker(){for(var e=usersOnline.length-1;e>=0;e--)usersOnline[e].uniqueID===user._id&&(usersOnline[e].lat=0,usersOnline[e].lng=0);for(var r=markersOnMap.length-1;r>=0;r--){var a=markersOnMap[r];if("localUserMarker"===a.id)return removeMarker(a),markersOnMap.splice(r,1),void(localUserOnMap=!1)}}function setTimerToXSecondsAfterDelay(e,r){setTimeout(function(){mapUpdateTimer=e},r)}var map=void 0,defaultLat=41.5,defaultLng=13.304,usersOnline=[],markersOnMap=[],localUserOnMap=!1,mapUpdateTimer=2e3,tenSeconds=1e4;$(document).ready(function(){if(!user.lat&&!user.lng){var e='Click "Broadcast Location" to show your position on the map to everyone.<br>       You can click "Erase Location" to hide your position.';"Ita"===localLanguage&&(e='Clicca su "Trasmetti Posizione" per mostrare a tutti la tua posizione sulla mappa.<br>       Puoi cliccare "Nascondi Posizione" per nascondere la tua posizione.'),showMessageOnMap(e)}updateMarkersOnMap();setInterval(updateMarkersOnMap,mapUpdateTimer);setTimerToXSecondsAfterDelay(tenSeconds,tenSeconds)});